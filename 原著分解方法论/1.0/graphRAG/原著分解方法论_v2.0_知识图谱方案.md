# 原著分解方法论 v2.0 - 知识图谱方案

> 版本：2.0（草案）
> 日期：2024-12-16
> 基于：v1.0 六大维度框架 + GraphRAG调研 + 增量扫描思路
> 状态：设计讨论阶段

---

## 一、核心理念演进

### v1.0 的局限（静态分解）

```
读完全书 → 一次性输出完整分解
```

问题：
- 对长篇小说不现实（如《天龙八部》370万字）
- 无法追踪信息的「演变」
- 无法体现「读者认知过程」

### v2.0 的核心思想（动态扫描）

```
读第1章 → 初始化结构 → 读第2章 → 更新结构 → ... → 读第N章 → 最终结构
```

**类比人类阅读**：边读边记笔记，不断修正对故事的理解

---

## 二、技术方案：知识图谱 + 增量更新

### 为什么选择知识图谱？

| 传统RAG | 知识图谱(GraphRAG) |
|---------|-------------------|
| 向量相似度搜索 | 结构化关系查询 |
| "乔峰阿朱相关段落" | "乔峰→阿朱 关系演变链" |
| 无法回答关系问题 | 精准回答"谁和谁有什么关系" |

### 技术选型

**参考方案**：[Microsoft GraphRAG](https://github.com/microsoft/graphrag)

**我们的改进**：在GraphRAG基础上增加「增量更新」和「时间演变追踪」

---

## 三、数据结构设计（支持成长性）

### 3.1 实体表（Entities）

```json
{
  "id": "entity_001",
  "name": "乔峰",
  "aliases": ["萧峰", "北乔峰"],
  "type": "人物",
  "first_appear": 1,
  "appear_in": [1, 3, 5, 12, 15, 20, 25],
  "identity_evolution": [
    {"chapter": 1, "identity": "丐帮帮主", "confidence": 1.0},
    {"chapter": 15, "identity": "契丹人", "revelation": true},
    {"chapter": 20, "identity": "萧远山之子", "revelation": true},
    {"chapter": 30, "identity": "辽国南院大王", "confidence": 1.0}
  ],
  "description_history": [
    {"chapter": 1, "desc": "丐帮帮主，武功盖世，为人豪迈"},
    {"chapter": 15, "desc": "身份被揭露为契丹人，陷入身份危机"}
  ]
}
```

**关键设计**：
- `first_appear`: 首次出现章节
- `appear_in`: 所有出现章节列表
- `identity_evolution`: 身份演变历史
- `description_history`: 描述演变历史

### 3.2 关系表（Relationships）

```json
{
  "id": "rel_001",
  "source": "乔峰",
  "target": "阿朱",
  "type": "情感",
  "first_chapter": 12,
  "last_chapter": 25,
  "status": "ended",
  "history": [
    {"chapter": 12, "state": "相识", "event": "聚贤庄初见"},
    {"chapter": 18, "state": "相爱", "event": "塞外定情"},
    {"chapter": 25, "state": "死亡", "event": "误杀阿朱", "turning_point": true}
  ]
}
```

**关键设计**：
- `status`: active / ended / changed
- `history`: 关系状态演变时间线
- `turning_point`: 标记重大转折

### 3.3 悬念表（Mysteries）

```json
{
  "id": "mystery_001",
  "question": "谁是带头大哥？",
  "status": "resolved",
  "raised_at": 15,
  "resolved_at": 43,
  "answer": "玄慈方丈",
  "clues": [
    {"chapter": 20, "hint": "是少林高手"},
    {"chapter": 35, "hint": "与叶二娘有关"},
    {"chapter": 40, "hint": "身份即将揭晓"}
  ]
}
```

**关键设计**：
- 追踪悬念的设置、线索铺垫、最终揭晓
- 支持「读者此时知道什么」的查询

### 3.4 势力表（Factions）

```json
{
  "id": "faction_001",
  "name": "丐帮",
  "type": "江湖门派",
  "first_appear": 1,
  "leader_history": [
    {"chapter": 1, "leader": "乔峰"},
    {"chapter": 20, "leader": "庄聚贤", "event": "乔峰被逐"}
  ],
  "members": ["乔峰", "马大元", "白世镜", "..."],
  "allies": ["少林"],
  "enemies": ["星宿派"]
}
```

### 3.5 事件表（Events）

```json
{
  "id": "event_001",
  "name": "杏子林事变",
  "chapter": 15,
  "type": "revelation",
  "description": "乔峰契丹身份被揭露，丐帮内乱",
  "participants": ["乔峰", "马大元", "全冠清"],
  "impacts": [
    {"entity": "乔峰", "impact": "身份危机，离开丐帮"},
    {"entity": "丐帮", "impact": "帮主更替"}
  ],
  "causes": ["带头大哥信件"],
  "consequences": ["event_002", "event_003"]
}
```

---

## 四、增量处理流程

### 4.1 整体流程

```
┌─────────────────────────────────────────────────┐
│                 第 N 章输入                      │
└─────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────┐
│              AI 阅读 & 分析                      │
│  - 识别新实体（人物/势力/武功/地点）            │
│  - 识别新关系或关系状态变化                     │
│  - 识别悬念的设置或解答                         │
│  - 识别重大事件                                 │
└─────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────┐
│           增量合并到知识图谱                     │
│  - INSERT: 新增实体/关系/事件                   │
│  - UPDATE: 更新已有条目的状态                   │
│  - APPEND: 追加演变历史记录                     │
└─────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────┐
│              持久化 & 可视化                     │
│  - 保存到SQLite/JSON                           │
│  - 生成当前状态的关系图                         │
└─────────────────────────────────────────────────┘
```

### 4.2 合并规则

**实体合并**：
```
IF 实体名称已存在:
    - 追加到 appear_in 列表
    - 如果描述有变化 → 追加到 description_history
    - 如果身份有变化 → 追加到 identity_evolution
ELSE:
    - 创建新实体记录
```

**关系合并**：
```
IF (source, target) 关系已存在:
    - 更新 last_chapter
    - 如果状态变化 → 追加到 history
    - 如果关系结束 → 更新 status = "ended"
ELSE:
    - 创建新关系记录
```

---

## 五、实体类型设计（武侠小说专用）

### 5.1 实体类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 人物 | 所有角色 | 乔峰、段誉、阿朱 |
| 门派势力 | 组织机构 | 丐帮、少林、大理国 |
| 武功招式 | 具体招式 | 降龙十八掌、六脉神剑 |
| 内功心法 | 修炼方法 | 北冥神功、易筋经 |
| 兵器法宝 | 武器物品 | 打狗棒、倚天剑 |
| 地点 | 地理位置 | 聚贤庄、少室山 |
| 事件 | 重要事件 | 杏子林事变 |
| 身份称号 | 江湖称号 | 北乔峰南慕容 |

### 5.2 关系类型

| 类型 | 子类型 | 示例 |
|------|--------|------|
| 亲属 | 父子/母子/兄弟/夫妻 | 萧远山→乔峰(父子) |
| 师徒 | 师父/徒弟 | 玄苦→乔峰(师徒) |
| 情感 | 相爱/暗恋/单恋 | 乔峰→阿朱(相爱) |
| 敌对 | 仇敌/对立 | 乔峰→慕容复(对立) |
| 从属 | 帮主/成员 | 乔峰→丐帮(帮主) |
| 武功 | 掌握/传授 | 乔峰→降龙十八掌(掌握) |

---

## 六、成本分析

### 6.1 建表成本（一次性）

以《天龙八部》为例（370万字，50章）：

```
每章约7万字 × 50章
每章处理成本（GPT-4o-mini）：约 $0.05-0.10
总建表成本：约 $2.5-5

建表后获得：
- 完整人物关系图谱
- 势力分布
- 事件索引
- 关系演变时间线
```

### 6.2 查询成本（持续使用）

```
查询走本地数据库 → 0 Token
仅生成回答时消耗少量Token
每次查询成本：约 $0.001-0.01
```

### 6.3 总结

```
一次投入（建表）：$5
永久获得：完整知识图谱
后续使用：几乎免费
```

---

## 七、存储方案

### 7.1 开发阶段：JSON文件

```
./项目/
├── entities.json       # 实体表
├── relationships.json  # 关系表
├── mysteries.json      # 悬念表
├── factions.json       # 势力表
├── events.json         # 事件表
└── metadata.json       # 元数据（当前章节、版本等）
```

优点：简单、可读、可版本控制

### 7.2 生产阶段：SQLite

```sql
-- 实体表
CREATE TABLE entities (
    id TEXT PRIMARY KEY,
    name TEXT UNIQUE,
    type TEXT,
    first_appear INTEGER,
    appear_in TEXT,  -- JSON array
    identity_evolution TEXT,  -- JSON array
    description_history TEXT  -- JSON array
);

-- 关系表
CREATE TABLE relationships (
    id TEXT PRIMARY KEY,
    source TEXT,
    target TEXT,
    type TEXT,
    first_chapter INTEGER,
    last_chapter INTEGER,
    status TEXT,
    history TEXT  -- JSON array
);
```

优点：SQL查询、单文件便携

---

## 八、可视化方案

### 8.1 快速预览：Pyvis（生成HTML）

```python
from pyvis.network import Network

net = Network(height="900px", width="100%")
# 添加节点和边...
net.show("关系图.html")
```

### 8.2 专业分析：Neo4j

适合大规模图探索和复杂查询

### 8.3 静态图片：NetworkX + Matplotlib

适合文档嵌入和报告

---

## 九、与v1.0方法论的对应

| v1.0 维度 | v2.0 知识图谱实现 |
|----------|------------------|
| 故事骨架 | 事件表 + 因果链 |
| 人物关系网 | 实体表 + 关系表（带演变历史） |
| 情感张力 | 关系表的history字段 |
| 世界规则 | 势力表 + 武功体系 |
| 可改写空间 | 待设计（可改写标注） |
| 场景清单 | 章节索引 + 事件表 |

---

## 十、下一步计划

### Phase 1：验证可行性
- [ ] 实现增量知识图谱构建器核心代码
- [ ] 用《孔乙己》测试基本流程
- [ ] 用《白马啸西风》测试增量合并

### Phase 2：完善系统
- [ ] 设计武侠小说专用Prompt
- [ ] 实现可视化工具
- [ ] 测试《天龙八部》（长篇）

### Phase 3：集成到产品
- [ ] 与蝴蝶效应系统对接
- [ ] 设计用户改写时的图谱查询API
- [ ] 实现「如果改变X会影响什么」的因果推理

---

## 附录：关键讨论记录

### Q1: 为什么不直接用GraphRAG？

GraphRAG是全量索引，每次重建全部表。我们需要：
- 增量更新（逐章处理）
- 演变追踪（关系状态变化）
- 悬念系统（线索追踪）

### Q2: 模型选择？

- 开发测试：GPT-4o-mini（成本低）
- 生产环境：GPT-4o（效果好）
- 需要自定义中文武侠Prompt

### Q3: 如何处理实体去重？

- 按名称匹配（需处理别名）
- 相似名称提示人工确认
- 维护别名映射表

---

## 参考资源

- [Microsoft GraphRAG GitHub](https://github.com/microsoft/graphrag)
- [GraphRAG 论文](https://arxiv.org/abs/2404.16130)
- [Neo4j 图数据库](https://neo4j.com/)
- [Pyvis 可视化](https://pyvis.readthedocs.io/)
